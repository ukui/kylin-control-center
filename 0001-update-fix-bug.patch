From 02a7f7ccb860c9c97d27f01f77d41f052e89febc Mon Sep 17 00:00:00 2001
From: wanghailiang <wanghailiang@kylinos.cn>
Date: Wed, 21 Jul 2021 20:30:17 +0800
Subject: [PATCH 1/2] =?UTF-8?q?update:fix=20bug:=2068495=20=E3=80=90?=
 =?UTF-8?q?=E5=86=85=E6=B5=8B=E3=80=91=E3=80=90=E6=9B=B4=E6=96=B0=E5=8D=87?=
 =?UTF-8?q?=E7=BA=A7=E3=80=91backup=E5=88=86=E5=8C=BA=E7=A9=BA=E9=97=B4?=
 =?UTF-8?q?=E4=B8=8D=E8=B6=B3=EF=BC=8C=E6=AD=A4=E6=97=B6=E7=82=B9=E5=87=BB?=
 =?UTF-8?q?=E5=85=A8=E9=83=A8=E6=9B=B4=E6=96=B0=E5=90=8E=E5=87=BA=E7=8E=B0?=
 =?UTF-8?q?=E5=A4=9A=E4=B8=AA=E5=BC=B9=E7=AA=97=E6=8F=90=E7=A4=BA=E5=88=86?=
 =?UTF-8?q?=E5=8C=BA=E5=BC=82=E5=B8=B8=2068508=20=E3=80=90=E5=86=85?=
 =?UTF-8?q?=E6=B5=8B=E3=80=91=E3=80=90iso0720=E3=80=91=E3=80=90=E6=9B=B4?=
 =?UTF-8?q?=E6=96=B0=E5=8D=87=E7=BA=A7=E3=80=91=E6=9B=B4=E6=96=B0=E5=AE=8C?=
 =?UTF-8?q?=E6=88=90=E9=94=81=E5=B1=8F=E6=9C=AA=E9=87=8A=E6=94=BE=E9=94=81?=
 =?UTF-8?q?=E6=96=87=E4=BB=B6=EF=BC=8C=E5=AF=BC=E8=87=B4=E6=97=A0=E6=B3=95?=
 =?UTF-8?q?=E9=87=8D=E5=90=AF=EF=BC=8C=E5=86=8D=E6=AC=A1=E5=AE=89=E8=A3=85?=
 =?UTF-8?q?=E5=8D=87=E7=BA=A7=E5=8C=85=E5=90=8E=E4=B8=8D=E5=85=B3=E9=97=AD?=
 =?UTF-8?q?=E6=8E=A7=E5=88=B6=E9=9D=A2=E7=89=88=E9=87=8D=E5=90=AF=E4=B8=8D?=
 =?UTF-8?q?=E6=8F=90=E7=A4=BA=E6=97=A0=E6=B3=95=E9=87=8D=E5=90=AF=EF=BC=8C?=
 =?UTF-8?q?=E6=97=A0=E9=94=81=E6=96=87=E4=BB=B6=E6=9C=AA=E5=88=9B=E5=BB=BA?=
 =?UTF-8?q?=2068509=20=E3=80=90=E5=86=85=E6=B5=8B=E3=80=91=E3=80=90iso0720?=
 =?UTF-8?q?=E3=80=91=E3=80=90=E6=9B=B4=E6=96=B0=E5=8D=87=E7=BA=A7=E3=80=91?=
 =?UTF-8?q?=E6=9B=B4=E6=96=B0=E5=AE=8C=E6=88=90=E4=B8=8D=E9=80=80=E5=87=BA?=
 =?UTF-8?q?=E6=8E=A7=E5=88=B6=E9=9D=A2=E6=9D=BF=E4=B8=8D=E8=83=BD=E5=85=B3?=
 =?UTF-8?q?=E6=9C=BA=2068493=20=E3=80=90=E5=86=85=E6=B5=8B=E3=80=91?=
 =?UTF-8?q?=E3=80=90=E6=9B=B4=E6=96=B0=E5=8D=87=E7=BA=A7=E3=80=91=E7=82=B9?=
 =?UTF-8?q?=E5=87=BB=E5=8D=95=E4=B8=AA=E6=9B=B4=E6=96=B0=E5=90=8E=EF=BC=8C?=
 =?UTF-8?q?=E5=85=A8=E9=83=A8=E6=9B=B4=E6=96=B0=E8=BF=98=E5=8F=AF=E4=BB=A5?=
 =?UTF-8?q?=E7=82=B9=E5=87=BB?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 plugins/security-updates/upgrade/src/appupdate.cpp |  9 +++++----
 plugins/security-updates/upgrade/src/tabwidget.cpp | 11 ++++++++---
 .../security-updates/upgrade/src/updatedbus.cpp    | 14 +++++++++-----
 3 files changed, 22 insertions(+), 12 deletions(-)

diff --git a/plugins/security-updates/upgrade/src/appupdate.cpp b/plugins/security-updates/upgrade/src/appupdate.cpp
index ddbbd78f..96288a46 100644
--- a/plugins/security-updates/upgrade/src/appupdate.cpp
+++ b/plugins/security-updates/upgrade/src/appupdate.cpp
@@ -634,6 +634,7 @@ void AppUpdateWid::updateOneApp()
 {
     if(appAllMsg.msg.getDepends == true)
     {
+        emit changeUpdateAllSignal();
         if(checkSourcesType() != file){
             isCancel = false;
             firstDownload = true;
@@ -749,10 +750,10 @@ void AppUpdateWid::calculateSpeedProgress()
             qDebug() << "dowload over:" << priorSize;
             timer->stop();
             m_updateMutual->copyFinsh(downloadPackages, appAllMsg.name);
-            if(m_updateMutual->fileLock() != false)
-            {
-                emit filelockedSignal();
-            }
+//            if(m_updateMutual->fileLock() != false)
+//            {
+//                emit filelockedSignal();
+//            }
 //            appVersion->setText(tr("准备安装"));
             appVersion->setText(tr("Ready to install"));
             appVersion->setToolTip("");
diff --git a/plugins/security-updates/upgrade/src/tabwidget.cpp b/plugins/security-updates/upgrade/src/tabwidget.cpp
index e00064aa..213cbc9f 100644
--- a/plugins/security-updates/upgrade/src/tabwidget.cpp
+++ b/plugins/security-updates/upgrade/src/tabwidget.cpp
@@ -475,8 +475,6 @@ void TabWid::allComponents()
 
 }
 
-
-
 void TabWid::loadingOneUpdateMsgSlot(AppAllMsg msg)
 {
     //    checkUpdateBtn->setText();
@@ -731,6 +729,7 @@ void TabWid::hideUpdateBtnSlot(bool isSucceed)
         checkUpdateBtn->stop();
         //        checkUpdateBtn->setText(tr("检查更新"));
         checkUpdateBtn->setText(tr("Check Update"));
+        updateMutual->fileUnLock();
         if(updateMutual->failedList.size() == 0)
         {
             //            versionInformationLab->setText(tr("您的系统已是最新！"));
@@ -747,13 +746,15 @@ void TabWid::hideUpdateBtnSlot(bool isSucceed)
 
 void TabWid::changeUpdateAllSlot()
 {
-
     if(checkUpdateBtn->isEnabled() == false)
     {
         //        checkUpdateBtn->setText("全部更新");
         checkUpdateBtn->setText(tr("UpdateAll"));
         checkUpdateBtn->setEnabled(true);
+    } else {
+        checkUpdateBtn->setEnabled(false);
     }
+
 }
 
 
@@ -787,18 +788,22 @@ void TabWid::receiveBackupStartResult(int result)
         return;
     case int(backuptools::backup_result::WRITE_STORAGEINFO_ADD_ITEM_FAIL):
     case int(backuptools::backup_result::WRITE_STORAGEINFO_UPDATE_ITEM_FAIL):
+        bacupInit(false);
         //        backupMessageBox(tr("写入配置文件失败，本次更新不会备份系统！"));
         backupMessageBox(tr("Failed to write configuration file, this update will not back up the system!"));
         break;
     case int(backuptools::backup_result::BACKUP_CAPACITY_IS_NOT_ENOUGH):
         //        backupMessageBox(tr("备份空间不足，本次更新不会备份系统！"));
+        bacupInit(false);
         backupMessageBox(tr("Insufficient backup space, this update will not backup your system!"));
         break;
     case int(backuptools::backup_result::INC_NOT_FOUND_UUID):
         //        backupMessageBox(tr("麒麟备份还原工具无法找到UUID，本次更新不会备份系统!"));
+        bacupInit(false);
         backupMessageBox(tr("Kylin backup restore tool could not find the UUID, this update will not backup the system!"));
         break;
     default:
+        bacupInit(false);
         backupMessageBox(tr("The backup restore partition is abnormal. You may not have a backup restore partition.For more details,see /var/log/backup.log"));
         break;
     }
diff --git a/plugins/security-updates/upgrade/src/updatedbus.cpp b/plugins/security-updates/upgrade/src/updatedbus.cpp
index 9f2d90ae..21f9bfb8 100644
--- a/plugins/security-updates/upgrade/src/updatedbus.cpp
+++ b/plugins/security-updates/upgrade/src/updatedbus.cpp
@@ -78,7 +78,7 @@ bool UpdateDbus::fileLock()
 
     //判断是否有lock目录，没有则创建
     QDir dir("/tmp/lock/");
-    if(! dir.exists()) {
+    if(!dir.exists()) {
         dir.mkdir("/tmp/lock/");//只创建一级子目录，即必须保证上级目录存在
         chmod("/tmp/lock/",0777);
     }
@@ -94,7 +94,7 @@ bool UpdateDbus::fileLock()
 
     umask(0000);
     //O_TRUNC 为先清空，再写入
-    int fd = open(lockPath.toUtf8().data(), O_RDWR | O_CREAT | O_TRUNC,0666);
+    int fd = open(lockPath.toStdString().c_str(), O_RDWR | O_CREAT | O_TRUNC,0666);
     if (fd < 0) {
         qDebug()<<"文件锁打开异常";
         return false;
@@ -109,18 +109,21 @@ bool UpdateDbus::fileLock()
 
 void UpdateDbus::fileUnLock()
 {
+
     QDir dir("/tmp/lock/");
-    if(! dir.exists()) {
+    if (!dir.exists()) {
         dir.mkdir("/tmp/lock/");//只创建一级子目录，即必须保证上级目录存在
         chmod("/tmp/lock/",0777);
     }
     umask(0000);
-    int fd = open(lockPath.toUtf8().data(), O_RDWR | O_CREAT,0666);
+    int fd = open(lockPath.toStdString().c_str(), O_RDONLY | O_CREAT,0666);
     if (fd < 0) {
         qDebug()<<"解锁时文件锁打开异常";
         return;
     }
     flock(fd, LOCK_UN);
+    close(fd);
+    system("rm /tmp/lock/kylin-update.lock");
 }
 
 void UpdateDbus::slotFinishGetMessage(QString num)
@@ -138,7 +141,7 @@ void UpdateDbus::copyFinsh(QStringList srcPath, QString appName)
     {
         makeDirs(QString("/var/cache/apt/archives/"));
     }
-    replyStr = interface->call("copy_file_to_install",srcPath,appName);
+    replyStr = interface->call("copy_file_to_install", srcPath, appName);
     qDebug() << "拷贝软件包到安装目录，调用接口copy_file_to_install";
 }
 
@@ -168,6 +171,7 @@ void UpdateDbus::setImportantStatus(bool status)
 //安装和升级
 bool UpdateDbus::installAndUpgrade(QString pkgName)
 {
+    fileLock();
     // 有参数的情况下  传参调用dbus接口并保存返回值
     interface->asyncCall("install_and_upgrade",pkgName);
 
-- 
2.25.1

